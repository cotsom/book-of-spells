---
description: limited delegation with protocol change
---

# S4U2Self & S4U2Proxy

Расширение _S4U2Self_ (Service for User to Self) применяется, если для аутентификации клиента к сервису с ограниченным делегированием требуется использовать любой отличный от Kerberos протокол, например NTLM. В этом случае клиент проходит аутентификацию, но не может передать TGS-билет, так как протокол Kerberos не используется. _S4U2Self_ позволяет сервису получить у контроллера домена Forwardable TGS-билет к самому себе от имени целевого пользователя.

Чтобы учетная запись получила право на ограниченное делегирование со сменой протокола (_S4U2Self_) в атрибуте _UserAccountControl_ указанной учетной записи необходимо установить флаг _TRUSTED\_TO\_AUTH\_FOR\_DELEGATION_, которому соответствует целочисленное значение 16777216.



<figure><img src="../../../../.gitbook/assets/image (12) (1).png" alt=""><figcaption></figcaption></figure>

1. User проходит аутентификацию к Сервису А по любому отличному от Kerberos протоколу, допустим NTLM.
2. Сервис А запрашивает у контроллера домена _Forwardable_ TGS-билет к самому себе от имени User.
3. Контроллер домена проверяет, что у учетной записи “Владелец А” в атрибуте _UserAccountControl_ установлен флаг _TRUSTED\_TO\_AUTH\_FOR\_AUTHENTICATION_. В результате успешной проверки контроллер домена отправляет Сервису А _Forwardable_ TGS-билет от имени User к самому Сервису А.

> При неуспешной проверке, например в случае отсутствии активного флага _TRUSTED\_TO\_AUTH\_FOR\_DELEGATION_ или если User состоит в группе “_Protected Users_”, в ответ будет передан TGS-билет без права передачи (_Nonforwardable_) для User к Сервису А.\
> Таким образом билет, полученный в результате выполнения S4U2Self-запроса может отличаться наличием флага _Forwardable_ в зависимости от настроек учетной записи и сервиса.

4. В дальнейшем для получения _Forwardable_ TGS-билет к Сервису Б от имени User используется расширение _S4U2Proxy_.

Важно отметить, что S4U2Self-запрос TGS-билета от имени произвольного пользователя может быть инициирован любой учетной записью, обладающей SPN, не дожидаясь аутентификации указанного пользователя.
