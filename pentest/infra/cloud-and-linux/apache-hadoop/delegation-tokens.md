# Delegation tokens

{% embed url="https://www.cloudera.com/blog/technical/hadoop-delegation-tokens-explained.html" %}

Thus Delegation Tokens were introduced as a lightweight authentication method to complement Kerberos authentication. Kerberos is a three-party protocol; in contrast, Delegation Token authentication is a two-party authentication protocol.

The way Delegation Tokens works is:

1. The client initially authenticates with each server via Kerberos, and obtains a Delegation Token from that server.
2. The client uses the Delegation Tokens for subsequent authentications with the servers instead of using Kerberos.

### Token's structure

| Kind            | The kind of token (HDFS\_DELEGATION\_TOKEN, or kms-dt). The token also contains the kind, matching the identifier’s kind.                                                                                                                         |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Owner           | The user who owns the token.                                                                                                                                                                                                                      |
| Renewer         | The user who can renew the token.                                                                                                                                                                                                                 |
| Real User       | <p>Only relevant if the owner is impersonated. If the token is created by an impersonating user, this will identify the impersonating user.<br> For example, when oozie impersonates user joe, Owner will be joe and Real User will be oozie.</p> |
| Issue Date      | Epoch time when the token was issued.                                                                                                                                                                                                             |
| Max Date        | Epoch time when the token can be renewed until.                                                                                                                                                                                                   |
| Sequence Number | UUID to identify the token.                                                                                                                                                                                                                       |
| Master Key ID   | ID of the master key used to create and verify the token.                                                                                                                                                                                         |

Table 1: Token Identifier (public part of a Delegation Token)

\


The private information is represented by class DelegationTokenInformation in [AbstractDelegationTokenSecretManager](https://github.com/cloudera/hadoop-common/blob/cdh5-2.6.0_5.13.0/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/token/delegation/AbstractDelegationTokenSecretManager.java), it is critical for security and contains the following fields:

| renewDate  | <p>Epoch time when the token is expected to be renewed.<br> If it’s smaller than the current time, it means the token has expired.</p>                                            |
| ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| password   | <p>The password calculated as HMAC of Token Identifier using master key as the HMAC key.<br> It’s used to validate the Delegation Token provided by the client to the server.</p> |
| trackingId | <p>A tracking identifier that can be used to associate usages of a token across multiple client sessions.<br> It is computed as the MD5 of the token identifier.</p>              |

Table 2: Delegation Token Information (private part of a Delegation Token)



The client-side-visible Token class is defined [here](https://github.com/cloudera/hadoop-common/blob/cdh5-2.6.0_5.13.0/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/security/token/Token.java). The following table describes what’s contained in the Token.

| identifier | The token identifier matching the public information part at the server side.                        |
| ---------- | ---------------------------------------------------------------------------------------------------- |
| password   | The password matching the password at the server side.                                               |
| kind       | The kind of token (e.g. HDFS\_DELEGATION\_TOKEN, or kms-dt), it matches the identifier’s kind.       |
| service    | The name of the service (e.g. ha-hdfs:\<nameservice-name> for HDFS, \<ip\_address>:\<port> for KMS). |
| renewer    | The user who can renew the token (e.g. yarn).                                                        |

Table 3: Delegation Token at Client Side
