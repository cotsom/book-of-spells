# Windows

## COM/DCOM

{% embed url="https://cicada-8.medium.com/impacket-developer-guide-part-1-rpc-4df4fe6d79d7" %}

{% embed url="https://cicada-8.medium.com/impacket-developer-guide-part-2-finding-rpc-on-the-system-and-some-words-about-in-security-7df65acbd621" %}

### IID (Interface ID)

`IID` — это GUID, который идентифицирует конкретный интерфейс COM-объекта.\
COM-объект может реализовывать несколько интерфейсов. Каждый интерфейс — это набор методов.

```
┌─────────────────────────────────────────────────────────────────┐
│                    COM Object (например, MMC20.Application)     │
│                    CLSID: 49B2791A-B1AE-4C90-9B8E-E860BA07F889  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   IUnknown      │  │   IDispatch     │  │  IApplication   │  │
│  │   (базовый)     │  │  (автоматизация)│  │  (специфичный)  │  │
│  │                 │  │                 │  │                 │  │
│  │ - QueryInterface│  │ - QueryInterface│  │ - Document      │  │
│  │ - AddRef        │  │ - AddRef        │  │ - ActiveView    │  │
│  │ - Release       │  │ - Release       │  │ - Load          │  │
│  │                 │  │ - GetTypeInfo   │  │ - Show          │  │
│  │                 │  │ - GetIDsOfNames │  │ - ExecuteShell..│  │
│  │                 │  │ - Invoke        │  │                 │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│         ▲                    ▲                    ▲             │
│   00000000-0000-       00020400-0000-       (свой IID)          │
│   0000-C000-...        0000-C000-...                            │
└─────────────────────────────────────────────────────────────────┘
```

### Dispatch (00020400-0000-0000-C000-000000000046)

`IDispatch` — это универсальный интерфейс автоматизации. Он позволяет вызывать методы объекта по имени (как строка), а не по фиксированному смещению.Методы IDispatch:

| GetTypeInfo   | Get information about types      |
| ------------- | -------------------------------- |
| GetIDsOfNames | Convert method name → integer ID |
| Invoke        | Invoke method by ID              |

### Архитектура DCOM вызова

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              DCOM Flow                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────┐          ┌──────────────────────────────────────────┐ │
│  │  1.ObjectExporter│  :135    │  ServerAlive2()                          │ │
│  │ (IObjectExporter)│          | → Получаем COM Version и bindings        │ │
│  └──────────────────┘          └──────────────────────────────────────────┘ │
│           │                                                                 │
│           ▼                                                                 │
│  ┌──────────────────┐          ┌──────────────────────────────────────────┐ │
│  │  2. Activation   │  :135    │  RemoteActivation(CLSID, IID)            │ │
│  │     (IActivation)|          │  → Активируем COM объект                 │ │
│  └──────────────────┘          │  → Получаем IPID и OXID bindings         │ │
│           │                    └──────────────────────────────────────────┘ │
│           ▼                                                                 │
│  ┌──────────────────┐          ┌──────────────────────────────────────────┐ │
│  │  3. WMI Login    │  :49xxx  │  NTLMLogin(namespace)                    │ │
│  │(IWbemLevel1Login)|          │  → Входим в root/cimv2                   │ │
│  └──────────────────┘          └──────────────────────────────────────────┘ │
│           │                                                                 │
│           ▼                                                                 │
│  ┌──────────────────┐          ┌──────────────────────────────────────────┐ │
│  │  4. WMI Services │  :49xxx  │  ExecMethod(Win32_Process.Create)        │ │
│  │  (IWbemServices) |          │  → Выполняем команду                     │ │
│  └──────────────────┘          └──────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```
